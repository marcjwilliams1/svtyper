SVTyper
=======
[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://raw.githubusercontent.com/marcjwilliams1/svtyper/master/LICENSE)

Bayesian genotyper for structural variants with single-cell support

## Overview

SVTyper performs breakpoint genotyping of structural variants (SVs) using whole genome sequencing data. Users must supply a VCF file of sites to genotype (which may be generated by [LUMPY](https://github.com/arq5x/lumpy-sv)) as well as a BAM/CRAM file of Illumina paired-end reads aligned with [BWA-MEM](https://github.com/lh3/bwa). SVTyper assesses discordant and concordant reads from paired-end and split-read alignments to infer genotypes at each site. Algorithm details and benchmarking are described in [Chiang et al., 2015](http://www.nature.com/nmeth/journal/vaop/ncurrent/full/nmeth.3505.html).

**This fork adds comprehensive single-cell BAM support** with cell barcode filtering and detailed read/cell tracking capabilities.

![NA12878 heterozygous deletion](etc/het.png?raw=true "NA12878 heterozygous deletion")

## Installation

Requirements:
- Python 3.6+
- pysam (version 0.15.0 or newer)
- numpy
- scipy

### Install via `pip`

```bash
pip install git+https://github.com/marcjwilliams1/svtyper.git
```

## New Features in This Fork

### ðŸ§¬ Single-Cell BAM Support
This fork adds comprehensive support for single-cell BAM files with cell barcodes (CB tags):

- **Cell ID Filtering**: Filter reads by specific cell IDs to genotype only selected cells
- **Cell ID Tracking**: Output cell IDs alongside supporting read names
- **Cell Count Statistics**: Get unique read and cell counts for each variant

### ðŸ”§ Enhanced Read Counting
- **Python 3+ Compatibility**: Updated from Python 2.7 to work with modern Python versions
- **Accurate Read Counts**: Counts represent actual number of supporting reads, not rounded MAPQ values (important for single-cell data where typically only 1 read supports an SV)
- **Duplicate Handling**: Option to include/exclude duplicate reads in counting
- **Both Sides Requirement**: Option to require reads align to both sides of breakpoint

### ðŸ“Š Detailed Output Options
- **Read Names Output**: Export supporting read names to companion file
- **Cell ID Output**: Export cell IDs corresponding to supporting reads  
- **Count Statistics**: Get unique counts of reads and cells supporting each variant

## Example Usage

### Basic Usage

```bash
svtyper \
    -i sv.vcf \
    -B sample.bam \
    -l sample.bam.json \
    -o sv.gt.vcf
```

### Single-Cell Usage

#### Filter by Specific Cell IDs

```bash
# Create file with allowed cell IDs (one per line)
echo "Cell_001" > allowed_cells.txt
echo "Cell_002" >> allowed_cells.txt
echo "Cell_003" >> allowed_cells.txt

# Run SVTyper with cell filtering
svtyper \
    -i sv.vcf \
    -B single_cell.bam \
    --cell_filter_file allowed_cells.txt \
    -o sv.gt.vcf
```

#### Output Cell IDs with Read Names

```bash
svtyper \
    -i sv.vcf \
    -B single_cell.bam \
    --read_names_out \
    --output_cell_ids \
    -o sv.gt.vcf
```

This creates two files:
- `sv.gt.vcf`: Genotyped variants
- `sv.gt.readnames`: Supporting read names and cell IDs with counts

#### Complete Single-Cell Workflow

```bash
svtyper \
    -i sv.vcf \
    -B single_cell.bam \
    --read_names_out \
    --output_cell_ids \
    --cell_filter_file allowed_cells.txt \
    -o sv.gt.vcf
```

### Read Names Output Format

#### Without Cell IDs (`--read_names_out`)
```
sv_id,sample,split_reads,span_reads,clip_reads,split_reads_count,span_reads_count,clip_reads_count
SV1,SAMPLE1,read1|read2,read3|read4,read5,2,2,1
```

#### With Cell IDs (`--read_names_out --output_cell_ids`)
```
sv_id,sample,split_reads,span_reads,clip_reads,split_reads_count,span_reads_count,clip_reads_count,split_cells,span_cells,clip_cells,split_cells_count,span_cells_count,clip_cells_count
SV1,SAMPLE1,read1|read2,read3|read4,read5,2,2,1,Cell_001|Cell_002,Cell_001|Cell_001,Cell_003,2,1,1
```

#### Output Count Matrices (`--output_matrices`)

Generate per-cell per-SV count matrices in CSV format:

```bash
svtyper \
    -i sv.vcf \
    -B single_cell.bam \
    --output_cell_ids \
    --output_matrices \
    -o sv.gt.vcf
```

This creates a `matrices/` subdirectory with the following files:
- `split_ref_counts.csv`: Reference split read counts per cell per SV
- `split_alt_counts.csv`: Alt split read counts per cell per SV
- `span_ref_counts.csv`: Reference spanning pair counts per cell per SV
- `span_alt_counts.csv`: Alt spanning pair counts per cell per SV
- `clip_alt_counts.csv`: Alt clipped read counts per cell per SV

Each matrix is in sparse CSV format with cells as rows and SVs as columns:
```
cell_id,SV1,SV2,SV3
Cell_001,2,0,1
Cell_002,0,3,0
Cell_003,1,1,2
```

## Command Line Options

### Single-Cell Specific Options

- `--cell_filter_file FILE`: File containing allowed cell IDs (one per line). Only reads from these cells will be processed.
- `--output_cell_ids`: Output cell IDs from CB tags alongside read names (requires `--read_names_out`).
- `--output_matrices`: Output per-cell per-SV count matrices to `matrices/` subdirectory (requires `--output_cell_ids`).

### General Options

- `-i, --input_vcf FILE`: VCF input (default: stdin)
- `-o, --output_vcf FILE`: Output VCF (default: stdout)
- `-B, --bam FILE`: BAM or CRAM file(s), comma-separated for multiple samples
- `-T, --ref_fasta FILE`: Indexed reference FASTA file (recommended for CRAM files)
- `-l, --lib_info FILE`: Create/read JSON file of library information
- `--read_names_out`: Output supporting read names to separate file
- `--keep_duplicates`: Keep duplicate reads for counting (default: False)
- `--both_sides`: Require reads to align to both sides of breakpoint
- `--max_reads INT`: Maximum reads to assess per variant (default: unlimited)
- `-m, --min_aligned INT`: Minimum aligned bases for read evidence (default: 20)

## Python Library Usage

```python
import svtyper.classic as svt

input_vcf = "/path/to/input.vcf"
input_bam = "/path/to/single_cell.bam"
library_info = "/path/to/library_info.json"
output_vcf = "/path/to/output.vcf"
cell_filter_file = "/path/to/allowed_cells.txt"

with open(input_vcf, "r") as inf, open(output_vcf, "w") as outf:
    svt.sv_genotype(
        bam_string=input_bam,
        vcf_in=inf,
        vcf_out=outf,
        min_aligned=20,
        split_weight=1,
        disc_weight=1,
        num_samp=1000000,
        lib_info_path=library_info,
        debug=False,
        clip_read_support=False,
        keep_duplicates=False,
        alignment_outpath=None,
        ref_fasta=None,
        sum_quals=False,
        max_reads=None,
        max_ci_dist=1e10,
        read_names_out=True,
        both_sides=False,
        output_cell_ids=True,  # New: output cell IDs
        cell_filter_file=cell_filter_file,  # New: filter by cell IDs
        output_matrices=True  # New: output count matrices
    )
```

## Single-Cell BAM Requirements

For single-cell functionality, BAM files must contain cell barcode information in CB tags:

```
@SQ	SN:chr1	LN:249250621
@RG	ID:sample	SM:sample
VL00477:83:AAGYGC2M5:1:1302:6643:29057	163	1	9998	0	75M	=	10022	99	CCATAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCC	IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII9IIIIIIIIIIIIIIIIIIIII9IIII	CB:Z:Cell_001	MC:Z:75M	MD:Z:1G73	RG:Z:sample
```

Reads without CB tags will be labeled as "UNKNOWN" and excluded when using `--cell_filter_file` (unless "UNKNOWN" is explicitly included in the filter file).

## `svtyper-sso` (Single Sample Optimized)

The `svtyper-sso` implementation provides parallelized genotyping for single samples:

```bash
svtyper-sso \
    --core 2 \
    --batch_size 1000 \
    --max_reads 1000 \
    -i sv.vcf \
    -B sample.bam \
    -l sample.bam.json \
    -o sv.gt.vcf
```

**Note**: `svtyper-sso` does not yet support the new single-cell features.

## Development

### Setting Up Development Environment

```bash
git clone https://github.com/marcjwilliams1/svtyper.git
cd svtyper
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -e .
make test
```

## Troubleshooting

### Library Statistics

Generate library statistics to assess BAM file quality:

```bash
svtyper -B my.bam -l my.bam.json
scripts/lib_stats.R my.bam.json my.bam.json.pdf
```

### Single-Cell Troubleshooting

- **No CB tags found**: Ensure your BAM file contains CB tags for cell barcodes
- **Cell filter not working**: Check that cell IDs in filter file exactly match CB tag values
- **Low read counts**: Single-cell data typically has lower coverage; consider adjusting `--min_aligned` parameter

## Citation

C Chiang, R M Layer, G G Faust, M R Lindberg, D B Rose, E P Garrison, G T Marth, A R Quinlan, and I M Hall. SpeedSeq: ultra-fast personal genome analysis and interpretation. Nat Meth 12, 966â€“968 (2015). doi:10.1038/nmeth.3505.

## Fork History

This fork is based on the original SVTyper implementation with significant enhancements:
- Original SVTyper: https://github.com/hall-lab/svtyper
- Python 3 port base: https://github.com/brentp/svtyper
- This enhanced fork: https://github.com/marcjwilliams1/svtyper

[0]: https://github.com/pysam-developers/pysam
[1]: http://www.numpy.org/
[2]: https://www.scipy.org/
[3]: https://github.com/pypa/virtualenv
[4]: https://conda.io/docs/index.html
[5]: https://docs.continuum.io/anaconda/
[6]: https://conda.io/miniconda.html
[7]: https://github.com/pytoolz/cytoolz
[8]: https://docs.python.org/2/library/multiprocessing.html